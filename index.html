<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker App</title>
  <link rel="stylesheet" href="styles.css">
  <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="server.js" defer></script>
  <iframe src="https://pay.google.com/gp/p/ui/payframe?origin=file%3A%2F%2F&amp" height="0" width="0" allowpaymentrequest="true" style="display: none; visibility: hidden;"></iframe>
</head>
<body>
    <div class="container">
        <!-- Login Container -->
        <div class="login-container show" id="login-container">
            <h2>Login</h2>
            <form id="login-form">
                <label for="login-username">Username:</label>
                <input type="text" id="login-username" name="username" required>
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" name="password" required>
                <button type="submit">Login</button>
            </form>
            <div class="switch-links">
                <a href="#" id="show-signup">Sign Up</a>
            </div>
        </div>

        <!-- Sign Up Container -->
        <div class="signup-container" id="signup-container">
            <h2>Sign Up</h2>
            <form id="signup-form">
                <label for="signup-username">Username:</label>
                <input type="text" id="signup-username" name="username" required>
                <label for="signup-password">Password:</label>
                <input type="password" id="signup-password" name="password" required>
                <button type="submit">Sign Up</button>
            </form>
            <div class="switch-links">
                <a href="#" id="show-login">Already have an account? Log In</a>
            </div>
        </div>

        <!-- Expense Tracker Container -->
        <div class="expense-tracker-container" id="expense-tracker-container">
            <h1>Expense Tracker App</h1>
            <div class="input-section">
                <label for="category-select">Category:</label>
                <select id="category-select">
                    <option value="">Select a category</option>
                    <option value="Food & Beverage">Food & Beverage</option>
                    <option value="Rent">Rent</option>
                    <option value="Transport">Transport</option>
                    <option value="Relaxing">Relaxing</option>
                </select>
                <label for="amount-input">Amount:</label>
                <input type="number" id="amount-input">
                <label for="date-input">Date:</label>
                <input type="date" id="date-input">
                <button id="add-btn">Add</button>
            </div>
            <div class="expenses-list">
                <h2>Expenses List</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td>Total:</td>
                            <td id="total-amount">0</td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="chart-container">
                <canvas id="pie-chart"></canvas>
            </div>
            <!-- Google Pay Container -->
            <div id="google-pay-button-container"></div>
        </div>
    </div>

    <script>
      const fontUrl = 'https://fonts.googleapis.com/css?family=Google+Sans:500'; // Correct
        function initializeGooglePay() {
            const paymentsClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });

            const googlePayButton = paymentsClient.createButton({
                buttonColor: 'black',
                buttonType: 'pay',
                onClick: onGooglePayButtonClicked
            });
            document.getElementById('google-pay-button-container').appendChild(googlePayButton);
        }

        async function onGooglePayButtonClicked() {
            try {
                const paymentDataRequest = {
                    apiVersion: 2,
                    apiVersionMinor: 0,
                    allowedPaymentMethods: [{
                        type: 'CARD',
                        parameters: {
                            allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
                            allowedCardNetworks: ['AMEX', 'DISCOVER', 'MASTERCARD', 'VISA']
                        },
                        tokenizationSpecification: {
                            type: 'PAYMENT_GATEWAY',
                            parameters: {
                                gateway: 'stripe',
                                gatewayMerchantId: 'your_stripe_merchant_id'
                            }
                        }
                    }],
                    merchantInfo: {
                        merchantName: 'Example Merchant',
                        merchantId: 'BCR2DN4TSWC73GJ5'
                    },
                    transactionInfo: {
                        totalPriceStatus: 'FINAL',
                        totalPrice: '10.00',
                        currencyCode: 'USD'
                    }
                };

                const paymentData = await paymentsClient.loadPaymentData(paymentDataRequest);
                console.log('Payment data received:', paymentData);

                const response = await fetch('http://localhost:3000/process-google-pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                if (response.ok) {
                    console.log('Payment successful');
                } else {
                    console.error('Payment failed:', response.statusText);
                }
            } catch (error) {
                console.error('Error during Google Pay transaction:', error);
            }
        }

        document.getElementById('show-signup').addEventListener('click', () => {
            document.getElementById('login-container').classList.remove('show');
            document.getElementById('signup-container').classList.add('show');
        });

        document.getElementById('show-login').addEventListener('click', () => {
            document.getElementById('signup-container').classList.remove('show');
            document.getElementById('login-container').classList.add('show');
        });

        const expenses = [];
        const expenseTableBody = document.getElementById('expense-table-body');
        const totalAmountElement = document.getElementById('total-amount');

        document.getElementById('add-btn').addEventListener('click', () => {
            const category = document.getElementById('category-select').value;
            const amount = parseFloat(document.getElementById('amount-input').value);
            const date = document.getElementById('date-input').value;

            if (category && !isNaN(amount) && date) {
                const expense = { category, amount, date };
                expenses.push(expense);
                updateExpenseTable();
                updatePieChart();
            }
        });

        function updateExpenseTable() {
            expenseTableBody.innerHTML = '';
            let totalAmount = 0;

            expenses.forEach((expense, index) => {
                totalAmount += expense.amount;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.category}</td>
                    <td>${expense.amount.toFixed(2)}</td>
                    <td>${expense.date}</td>
                    <td><button class="delete-btn" onclick="deleteExpense(${index})">Delete</button></td>
                `;
                expenseTableBody.appendChild(row);
            });

            totalAmountElement.textContent = totalAmount.toFixed(2);
        }

        function deleteExpense(index) {
            expenses.splice(index, 1);
            updateExpenseTable();
            updatePieChart();
        }

        const ctx = document.getElementById('pie-chart').getContext('2d');
        const pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const dataLabel = tooltipItem.label || '';
                                const value = tooltipItem.raw || 0;
                                return `${dataLabel}: $${value.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });

        function updatePieChart() {
            const categoryTotals = {};
            expenses.forEach(expense => {
                if (!categoryTotals[expense.category]) {
                    categoryTotals[expense.category] = 0;
                }
                categoryTotals[expense.category] += expense.amount;
            });

            pieChart.data.labels = Object.keys(categoryTotals);
            pieChart.data.datasets[0].data = Object.values(categoryTotals);
            pieChart.update();
        }

        // Initialize Google Pay Button
        window.onload = initializeGooglePay;
    </script>
</body>
</html>
